!function(e,t){"function"==typeof define&&define.amd?(e.LazyJsonUndoRedo=t(),define(function(){return e.LazyJsonUndoRedo})):"object"==typeof exports?module.exports=t():e.LazyJsonUndoRedo=t()}(this,function(){"use strict";function e(t){var i=e.checkSupport();if("polymer"===i)this.usePolymerShim();else if(!i)throw Error("This environment doesn't support the ES6 Object.observe()");this._history=[],this._whitelists=[],this._pointer=-1,this._recChanges=this._recChanges.bind(this),this.observeTree(t)}var t=0,i=e.prototype;return i.observeTree=function(e,t){e&&"object"==typeof e&&(t=(t||[]).concat([e]),this.observe(e),Object.keys(e).forEach(function(i){"object"==typeof e[i]&&-1===t.indexOf(e[i])&&this._isListenable(e,i)&&this.observeTree(e[i],t)},this))},i.unobserveTree=function(e,t){e&&"object"==typeof e&&(t=(t||[]).concat([e]),this.unobserve(e),Object.keys(e).forEach(function(i){"object"==typeof e[i]&&-1===t.indexOf(e[i])&&this.unobserveTree(e[i])},this))},i._recChanges=function(e){this._pointer<this._history.length-1&&this._history.splice(this._pointer+1),e.forEach(function(e){if("number"==typeof e)this._history.push(e),++this._pointer;else if(this._isListenable(e.object,e.name)){var t=Object.create(null);Object.keys(e).forEach(function(i){t[i]=e[i]}),this._history.push(t),this.observeTree(e.object),++this._pointer}},this)},i.undo=function(){if(this.rec(),this._pointer<0)return!1;var e=this._history[this._pointer--];if("number"==typeof e){var t=this._history.indexOf(e-1);if(-1!==t){for(;this._pointer!==t;)this._reverseRecord(this._history[this._pointer--]);this._pointer--}}else this._reverseRecord(e)},i.redo=function(){if(this.rec(),this._pointer>=this._history.length-1)return!1;var e=this._history[++this._pointer];if("number"==typeof e){var t=this._history.indexOf(e+1);if(-1!==t)for(;++this._pointer!==t;)this._reverseRecord(this._history[this._pointer])}else this._reverseRecord(e)},i.rec=function(){Object.deliverChangeRecords(this._recChanges)},i._reverseRecord=function(e){if("number"!=typeof e){var t;switch(this.unobserve(e.object),e.type){case"add":e.type="delete",e.oldValue=e.object[e.name],delete e.object[e.name];break;case"update":t=e.object[e.name],e.object[e.name]=e.oldValue,e.oldValue=t;break;case"delete":e.type="add",e.object[e.name]=e.oldValue,delete e.oldValue;break;case"splice":t=Array.prototype.splice.apply(e.object,[e.index,e.addedCount].concat(e.removed)),e.addedCount=e.removed.length,e.removed=t}this.observe(e.object)}},i.startFlag=function(){return this.rec(),this._recChanges([t++]),t++},i.endFlag=function(e){this.rec(),this._recChanges([e])},i.wrap=function(e,t){var i=this;return function(){var r=i.startFlag();e.apply(t,Array.prototype.slice.call(arguments,2)),i.endFlag(r)}},i.setWhitelist=function(e,t){this.removeWhitelist(e),this._whitelists.push({obj:e,list:t})},i.getWhitelist=function(e){for(var t=0,i=this._whitelists.length;i>t;++t)if(this._whitelists[t].obj===e)return this._whitelists[t]},i.removeWhitelist=function(e){for(var t=0;t<this._whitelists.length;++t)this._whitelists[t].obj===e&&this._whitelists.splice(t--,1)},i._isListenable=function(e,t){var i=this.getWhitelist(e);return i&&-1===i.list.indexOf(t)?!1:!0},i.observe=function(e){var t=e.constructor&&e.constructor.observe||Array.isArray(e)?Array.observe:Object.observe;t(e,this._recChanges)},i.unobserve=function(e){var t=e.constructor&&e.constructor.unobserve||Array.isArray(e)?Array.unobserve:Object.unobserve;t(e,this._recChanges)},e.checkSupport=function(){return"function"==typeof Object.observe&&"function"==typeof Array.observe?"native":window.Platform&&"function"==typeof Platform.performMicrotaskCheckpoint&&"function"==typeof window.ObjectObserver&&"function"==typeof window.ArrayObserver?"polymer":!1},i.usePolymerShim=function(){function e(e){return-1!==s.indexOf(e)}function t(t){if(!e(t)){var i=this,o=new ObjectObserver(t);s.push(t),r.push(o),o.open(function(e,r,s,o){var n=[];Object.keys(e).forEach(function(e){n.push({object:t,type:"add",name:e})}),Object.keys(r).forEach(function(e){n.push({object:t,type:"delete",name:e,oldValue:o(e)})}),Object.keys(s).forEach(function(e){n.push({object:t,type:"update",name:e,oldValue:o(e)})}),i._recChanges(n)})}}function i(t){if(!e(t)){var i=this,o=new ArrayObserver(t);s.push(t),r.push(o),o.open(function(e){e.forEach(function(e){e.object=t,e.type="splice"}),i._recChanges(e)})}}if(!this._isPolymerShimInited){this._isPolymerShimInited=!0,this.usingShim=!0;var r=[],s=[];this.rec=function(){Platform.performMicrotaskCheckpoint()},this.observe=function(e){Array.isArray(e)?i.call(this,e):t.call(this,e)},this.unobserve=function(e){var t=s.indexOf(e);-1!==t&&(s.splice(t,1),r.splice(t,1)[0].close())}}},e});
//# sourceMappingURL=LazyJsonUndoRedo.min.js.map